@page
@model Server.Pages.User.Card.IndexModel
@{
    var pagetitle = Resources.DataDictionary.Card;

    ViewData["pagetitle"] = pagetitle;

    Layout = "Layouts/Ltr/_Layout";

    var Sales = Model._context.Sales.Where(x => x.UserId == Model.UserId).ToList();
}

<br />
<br />
<br />
<br />

<div class="container">
    <div class="row mt-2">
        <div class="col-md-8 p-2">
            @if (Sales.Count == 0)
            {
                <div class="border rounded-1 p-5 text-center">
                    <h1>سبد خالیه!</h1>
                </div>
            }
            @if (Sales.Count != 0)
            {
                <div class="border rounded-1 p-2">
                    @foreach (var item in Sales)
                    {
                        Model.ViewModelSale.Number = item.Number;

                        var product = Model._context.Products.FirstOrDefault(x => x.Id == item.ProductId);
                        var pic = Model._context.ProductsPic.FirstOrDefault(x => x.Product_Id == product.Id);
                        var category = Model._context.Categories.FirstOrDefault(x => x.Id == product.CategoryParent_Id);

                        int? totalprice = (item.Price * item.Number);

                        decimal price = decimal.Parse(totalprice.ToString(), System.Globalization.NumberStyles.Currency);

                        if (item.Number <= product.Number)
                        {
                            int? sum = Model.pricetotal.Value + totalprice;

                            Model.pricetotal = int.Parse(sum.ToString(), System.Globalization.NumberStyles.Currency);
                        }

                        <div class="row">
                            <div class="col-md-6 my-2">
                                @if (pic == null)
                                {
                                    <img width="100%" height="300" src="~/images/download.png" class="rounded-3" alt="@(product.Name_Product)">
                                }
                                @if (pic != null)
                                {
                                    <img width="100%" height="300" src="~/ProductPic/@(pic.PicAddress1)" class="rounded-3" alt="@(product.Name_Product)">
                                }
                            </div>
                            <div class="col-md-6 my-2">
                                <div class="w-100 rounded-2 bg-danger p-2 text-white mb-2">
                                    <div class="row">
                                        <div class="col-9">
                                            <h3>@(product.Name_Product)</h3>
                                        </div>
                                        @if (item.Number <= product.Number)
                                        {
                                            <div class="col-3">
                                                <p class="text-light">@(Resources.DataDictionary.Available)</p>
                                            </div>
                                        }
                                        @if (item.Number > product.Number)
                                        {
                                            <div class="col-3">
                                                <p class="text-light">@(Resources.DataDictionary.Unavailable)</p>
                                            </div>
                                        }
                                        <div class="col-12">
                                            <h6 class="text-light">@(category.Name)</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <h5>@(Resources.DataDictionary.Gender) : @(product.Gender)</h5>
                                        <h5>@(Resources.DataDictionary.Type) : @(product.Type)</h5>
                                    </div>
                                    <div class="col-6">
                                        <h5>@(Resources.DataDictionary.Number) : @(item.Number)</h5>
                                        <h5>@(Resources.DataDictionary.PriceTotal) : @(price.ToString("#,#"))</h5>
                                    </div>
                                    <div class="col-12">
                                        <div class="row">
                                            @*<div class="col-6">
                                                <br />
                                                <br />
                                                <form method="post" asp-page-handler="Delete">
                                                    <button type="submit" asp-route-id="@(item.Id)" class="btn btn-danger">@(Html.DtatGetIconDelete()) @(Resources.ButtonCaptions.Delete)</button>
                                                </form>
                                            </div>*@
                                            <div class="col-6">
                                                <br />
                                                <br />
                                                <form method="post" asp-page-handler="Update">
                                                    <div class="input-group mb-3 w-100">
                                                        <button asp-route-id="@(item.Id)" asp-route-check="Add" type="submit" class="btn btn-outline-danger rounded-3">+</button>
                                                        <input asp-for="ViewModelSale.Number" value="@(Model.ViewModelSale.Number)" type="number" class="form-control rounded-3 text-center" readonly>
                                                        <button asp-route-id="@(item.Id)" asp-route-check="Low" type="submit" class="btn btn-outline-danger rounded-3">-</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr />
                    }
                </div>
            }
        </div>
        <div class="col-md-4 p-2">
            @if (Sales.Count != 0)
            {

                <div class="border rounded-1 p-2">
                    <h6><i class="bi bi-tag"></i> @(Resources.DataDictionary.Price) : @(Model.pricetotal.Value.ToString("#,#"))</h6>
                    <h6><i class="bi bi-truck"></i> @(Resources.DataDictionary.ShippingCost) : </h6>
                    <h6><i class="bi bi-cash"></i> @(Resources.DataDictionary.PriceTotal) : @(Model.pricetotal.Value.ToString("#,#"))</h6>
                    <div class="alert alert-danger">
                        مبلغ قیمت کل را به حساب زیر واریز کرده و عکس رسید را باگزاری کنید
                    </div>
                    <div class="w-100 bg-light rounded-2 border p-2">
                        <h5 class="text-start">6063731113567086</h5>
                        <h6 class="text-end">به نام : فهیمه کرامتی</h6>
                    </div>
                    <hr />
                    <form method="post" enctype="multipart/form-data" asp-page-handler="Create">
                        <input class="form-control mb-2" asp-for="UploadPic" accept="image/*" />
                        <span class="text-danger mb-2" asp-validation-for="UploadPic"></span>
                        <button type="submit" class="w-100 btn btn-danger">@(Resources.DataDictionary.Order)</button>
                    </form>
                </div>
            }
        </div>
    </div>
</div>